<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.58.3" />
    <meta name="description" content="">


    <link rel="icon" href="/docs/images/favicon.png" type="image/png">

    <title>Security :: My New Hugo Site</title>

    
    <link href="/docs/css/nucleus.css?1571220765" rel="stylesheet">
    <link href="/docs/css/fontawesome-all.min.css?1571220765" rel="stylesheet">
    <link href="/docs/css/hybrid.css?1571220765" rel="stylesheet">
    <link href="/docs/css/featherlight.min.css?1571220765" rel="stylesheet">
    <link href="/docs/css/perfect-scrollbar.min.css?1571220765" rel="stylesheet">
    <link href="/docs/css/auto-complete.css?1571220765" rel="stylesheet">
    <link href="/docs/css/atom-one-dark-reasonable.css?1571220765" rel="stylesheet">
    <link href="/docs/css/theme.css?1571220765" rel="stylesheet">
    <link href="/docs/css/hugo-theme.css?1571220765" rel="stylesheet">
    
      <link href="/docs/css/theme-mine.css?1571220765" rel="stylesheet">
    

    <script src="/docs/js/jquery-3.3.1.min.js?1571220765"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/docs/security/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="//egendata.github.io/docs">
  <svg id="grav-logo" style="width:100%; height:100%;" viewBox="0 0 504 140" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421;">
    <path d="M235.832,71.564l-7.98,-0.001c-1.213,0.001 -2.197,0.987 -2.197,2.204l0,15.327l-0.158,0.132c-4.696,3.962 -10.634,6.14 -16.719,6.14c-14.356,0 -26.034,-11.68 -26.034,-26.037c0,-14.358 11.678,-26.035 26.034,-26.035c5.582,0 10.919,1.767 15.437,5.113c0.877,0.649 2.093,0.56 2.866,-0.211l5.69,-5.69c0.444,-0.442 0.675,-1.055 0.639,-1.681c-0.034,-0.627 -0.336,-1.206 -0.828,-1.597c-6.76,-5.363 -15.214,-8.314 -23.805,-8.314c-21.18,0 -38.414,17.233 -38.414,38.415c0,21.183 17.234,38.415 38.414,38.415c10.937,0 21.397,-4.705 28.698,-12.914c0.358,-0.403 0.556,-0.921 0.556,-1.46l0,-19.603c0,-1.217 -0.985,-2.203 -2.2,-2.203"
      style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M502.794,34.445c-0.408,-0.616 -1.1,-0.989 -1.838,-0.989l-8.684,0c-0.879,0 -1.673,0.522 -2.022,1.329l-24.483,56.839l-24.92,-56.852c-0.352,-0.799 -1.142,-1.316 -2.012,-1.316l-8.713,0c-0.744,0 -1.44,0.373 -1.843,0.995c-0.408,0.623 -0.476,1.408 -0.174,2.09l30.186,68.858c0.352,0.799 1.143,1.317 2.017,1.317l10.992,0c0.879,0 1.673,-0.527 2.021,-1.329l29.655,-68.861c0.289,-0.68 0.222,-1.461 -0.182,-2.081"
      style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M388.683,34.772c-0.353,-0.798 -1.142,-1.316 -2.017,-1.316l-10.988,0c-0.879,0 -1.673,0.522 -2.021,1.329l-29.655,68.861c-0.294,0.675 -0.226,1.46 0.182,2.077c0.407,0.619 1.096,0.993 1.838,0.993l8.684,0c0.879,0 1.673,-0.526 2.022,-1.329l24.478,-56.842l24.92,56.854c0.353,0.798 1.143,1.317 2.013,1.317l8.717,0c0.744,0 1.44,-0.374 1.843,-0.993c0.408,-0.624 0.471,-1.41 0.174,-2.094l-30.19,-68.857Z"
      style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M309.196,81.525l0.476,-0.229c8.675,-4.191 14.279,-13.087 14.279,-22.667c0,-13.881 -11.295,-25.174 -25.176,-25.174l-31.863,0c-1.214,0 -2.199,0.988 -2.199,2.202l0,68.855c0,1.219 0.985,2.204 2.199,2.204l7.979,0c1.214,0 2.2,-0.985 2.2,-2.204l0,-58.679l21.684,0c7.059,0 12.799,5.739 12.799,12.796c0,5.885 -3.996,10.989 -9.728,12.408c-1.032,0.261 -2.064,0.393 -3.071,0.393l-7.977,0c-0.829,0 -1.585,0.467 -1.959,1.205c-0.378,0.74 -0.305,1.625 0.187,2.296l22.62,30.884c0.412,0.566 1.07,0.901 1.771,0.901l9.915,0c0.827,0 1.587,-0.467 1.96,-1.207c0.378,-0.742 0.302,-1.629 -0.186,-2.296l-15.91,-21.688Z"
      style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M107.191,80.969c-7.255,-4.794 -11.4,-8.845 -15.011,-16.109c-2.47,4.977 -8.236,12.376 -17.962,18.198c-4.856,15.106 -27.954,44.015 -35.43,39.916c-2.213,-1.212 -2.633,-2.808 -2.133,-4.456c0.536,-4.129 9.078,-13.62 9.078,-13.62c0,0 0.18,1.992 2.913,6.187c-3.609,-11.205 5.965,-25.031 8.5,-29.738c3.985,-1.269 4.274,-6.387 4.274,-6.387c0.255,-7.909 -3.278,-13.635 -6.701,-17.059c2.459,3.002 3.255,7.539 3.372,11.694l0,0.023c0.012,0.469 0.012,0.93 0.011,1.39c-0.117,3.439 -1.157,8.19 -3.383,8.19l0.006,0.03c-2.289,-0.098 -5.115,0.391 -7.639,1.18l-5.582,1.334c0,0 2.977,-0.136 4.584,1.252c-1.79,2.915 -5.769,6.533 -10.206,8.588c-6.457,2.995 -8.312,-2.964 -5.034,-6.838c0.805,-0.946 1.618,-1.745 2.387,-2.399c-0.495,-0.513 -0.807,-1.198 -0.889,-2.068c-0.001,-0.005 -0.004,-0.009 -0.005,-0.013c-0.45,-1.977 -0.202,-4.543 2.596,-8.623c0.551,-0.863 1.214,-1.748 2.007,-2.647c0.025,-0.031 0.046,-0.059 0.072,-0.089c0.034,-0.042 0.072,-0.08 0.108,-0.121c0.02,-0.023 0.039,-0.045 0.059,-0.068c0.2,-0.228 0.413,-0.45 0.639,-0.663c3.334,-3.414 8.599,-6.966 16.897,-10.152c9.675,-14.223 13.219,-16.89 13.219,-16.89c1.071,-1.096 2.943,-2.458 3.632,-2.805c-5.053,-8.781 -6.074,-21.158 -4.75,-24.493c-0.107,0.18 -0.206,0.365 -0.287,0.556c0.49,-1.143 0.819,-1.509 1.328,-2.111c1.381,-1.632 6.058,-2.488 7.737,0.971c0.895,1.844 1.063,4.232 1.034,6.023c-3.704,-0.193 -7.063,4.036 -7.063,4.036c0,0 3.067,-1.448 6.879,-1.473c0,0 1.015,0.883 2.283,2.542c-1.712,3.213 -4.524,10.021 -2.488,17.168c0.338,1.408 0.849,2.619 1.483,3.648c0.024,0.045 0.044,0.089 0.069,0.135c0.051,0.066 0.096,0.122 0.144,0.183c3.368,5.072 9.542,5.665 9.542,5.665c-2.906,-1.45 -5.274,-3.76 -6.816,-6.56c-0.8,-1.498 -1.291,-2.762 -1.592,-3.761c-1.636,-6.313 0.771,-9.999 2.149,-12.471c3.17,-4.917 8.944,-7.893 15.151,-7.185c8.712,0.995 14.968,8.862 13.973,17.571c-0.608,5.321 -3.781,9.723 -8.142,12.117c1.049,2.839 -0.073,6.28 -0.073,6.28c2.642,3.323 2.758,5.238 2.667,7.017c-3.357,-0.565 -6.618,1.701 -6.618,1.701c0,0 6.476,-1.546 10.238,1.81c2.446,2.631 4.078,5.009 5.051,6.766c1.393,2.505 7.859,2.683 7.123,7.188c-0.737,4.499 -5.669,4.542 -13.401,-0.56M69.571,0c-38.424,0 -69.571,31.148 -69.571,69.567c0,38.422 31.147,69.573 69.571,69.573c38.42,0 69.568,-31.151 69.568,-69.573c0,-38.42 -31.148,-69.567 -69.568,-69.567"
      style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M73.796,51.693c0.813,-0.814 0.813,-2.134 0,-2.947c-0.815,-0.814 -2.133,-0.814 -2.947,0c-0.815,0.813 -0.815,2.133 0,2.947c0.814,0.813 2.132,0.813 2.947,0" style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M66.445,53.149c-0.814,0.813 -0.814,2.133 0,2.947c0.813,0.814 2.133,0.814 2.947,0c0.813,-0.814 0.813,-2.134 0,-2.947c-0.814,-0.813 -2.134,-0.813 -2.947,0" style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M79.231,54.233c-1.274,-1.274 -3.339,-1.272 -4.611,0l-2.713,2.712c-1.274,1.275 -1.274,3.339 0,4.612l2.978,2.978c1.274,1.275 3.338,1.274 4.611,0l2.712,-2.712c1.274,-1.274 1.274,-3.339 0,-4.612l-2.977,-2.978Z" style="fill:#000;fill-rule:nonzero;"></path>
    <path d="M95.759,41.445c-2.151,-2.578 1.869,-7.257 4.391,-4.463c4.645,5.148 -2.237,7.041 -4.391,4.463M105.004,44.132c3.442,-6.553 -1.427,-10.381 -4.773,-13.523c-5.36,-5.039 -10.706,-7.217 -16.811,-0.241c-6.102,6.977 -2.226,15.068 3.356,19.061c5.584,3.994 14.782,1.255 18.228,-5.297"
      style="fill:#000;fill-rule:nonzero;"></path>
  </svg>
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/docs/js/lunr.min.js?1571220765"></script>
<script type="text/javascript" src="/docs/js/auto-complete.js?1571220765"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/egendata.github.io\/docs";
    
</script>
<script type="text/javascript" src="/docs/js/search.js?1571220765"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/docs/architecture/" title="Architecture" class="dd-item 
        
        
        
        ">
      <a href="/docs/architecture/">
          Architecture
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/docs/client/" title="Client" class="dd-item 
        
        
        
        ">
      <a href="/docs/client/">
          Client
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/docs/cryptography/" title="Cryptography" class="dd-item 
        
        
        
        ">
      <a href="/docs/cryptography/">
          Cryptography
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/docs/operator/" title="Operator" class="dd-item 
        
        
        
        ">
      <a href="/docs/operator/">
          Operator
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/docs/security/" title="Security" class="dd-item 
        parent
        active
        
        ">
      <a href="/docs/security/">
          Security
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/docs/services/" title="Services" class="dd-item 
        
        
        
        ">
      <a href="/docs/services/">
          Services
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='/docs/'>Introduction</a> > Security
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li><a href="#encryption-and-signing">Encryption and signing</a>
<ul>
<li><a href="#algorithms">Algorithms</a></li>
<li><a href="#data-storage-and-transmission">Data storage and transmission</a></li>
<li><a href="#trust-establishment">Trust establishment</a></li>
<li><a href="#egendata-messages-properties-and-purposes">Egendata messages properties and purposes</a>
<ul>
<li><a href="#service-registration">SERVICE_REGISTRATION</a></li>
<li><a href="#account-registration">ACCOUNT_REGISTRATION</a></li>
<li><a href="#authentication-request">AUTHENTICATION_REQUEST</a></li>
<li><a href="#connection-init">CONNECTION_INIT</a></li>
<li><a href="#lawful-basis">LAWFUL_BASIS</a></li>
<li><a href="#content-path">CONTENT_PATH</a></li>
<li><a href="#permission-base">PERMISSION_BASE</a></li>
<li><a href="#read-permission-request">READ_PERMISSION_REQUEST</a></li>
<li><a href="#write-permission-request">WRITE_PERMISSION_REQUEST</a></li>
<li><a href="#permission-request-array">PERMISSION_REQUEST_ARRAY</a></li>
<li><a href="#read-permission">READ_PERMISSION</a></li>
<li><a href="#write-permission">WRITE_PERMISSION</a></li>
<li><a href="#permission-array">PERMISSION_ARRAY</a></li>
<li><a href="#permission-denied">PERMISSION_DENIED</a></li>
<li><a href="#permission-request">PERMISSION_REQUEST</a></li>
<li><a href="#connection-request">CONNECTION_REQUEST</a></li>
<li><a href="#connection">CONNECTION</a></li>
<li><a href="#connection-response">CONNECTION_RESPONSE</a></li>
<li><a href="#connection-event">CONNECTION_EVENT</a></li>
<li><a href="#login">LOGIN</a></li>
<li><a href="#login-response">LOGIN_RESPONSE</a></li>
<li><a href="#login-event">LOGIN_EVENT</a></li>
<li><a href="#access-token">ACCESS_TOKEN</a></li>
<li><a href="#data-read-request">DATA_READ_REQUEST</a></li>
<li><a href="#data-read-response">DATA_READ_RESPONSE</a></li>
<li><a href="#data-write">DATA_WRITE</a></li>
</ul></li>
<li><a href="#steps-performed-upon-writing-to-pds">Steps performed upon writing to PDS.</a>
<ul>
<li><a href="#at-the-service">At the service</a></li>
<li><a href="#at-the-operator">At the operator</a></li>
</ul></li>
<li><a href="#steps-performed-upon-reading-from-pds">Steps performed upon reading from PDS</a>
<ul>
<li><a href="#at-the-service-1">At the service</a></li>
<li><a href="#at-the-operator-1">At the operator</a></li>
<li><a href="#at-the-service-2">At the service</a></li>
</ul></li>
<li><a href="#future-plans-suggestions">Future plans / Suggestions</a></li>
<li><a href="#other">Other</a></li>
</ul></li>
<li><a href="#data">Data</a>
<ul>
<li><a href="#data-structures-storage">Data structures &amp; storage</a></li>
<li><a href="#step-by-step-for-data-generation">Step-by-step for data generation</a>
<ul>
<li><a href="#registering-of-a-service">Registering of a service</a></li>
<li><a href="#registering-a-user">Registering a user</a></li>
<li><a href="#logging-in-to-a-service-with-egendata">Logging in to a service with Egendata</a>
<ul>
<li><a href="#with-an-established-connection">With an established connection</a></li>
<li><a href="#without-an-established-connection">Without an established connection</a></li>
</ul></li>
</ul></li>
<li><a href="#reading-data-from-pds">Reading data from PDS</a></li>
<li><a href="#writing-data-to-a-pds">Writing data to a PDS</a></li>
<li><a href="#configuration-properties-for-client-library">Configuration properties for Client library</a></li>
</ul></li>
<li><a href="#keyprovider-client">KeyProvider (Client)</a>
<ul>
<li><a href="#prefixes-defined-in-client-library">Prefixes defined in Client library</a></li>
<li><a href="#saving-key-to-keyvaluestore">Saving key to keyValueStore</a></li>
<li><a href="#saving-write-keys-to-keyvaluestore">Saving write keys to keyValueStore:</a></li>
<li><a href="#saving-authentication-token-to-keyvaluestore">Saving authentication token to keyValueStore</a></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Security
            </h1>
          

        




	

<h1 id="encryption-and-signing">Encryption and signing</h1>

<p>The Egendata solution uses standard algorithms for all encryption and signatures.</p>

<h2 id="algorithms">Algorithms</h2>

<p>The Egendata solution uses the following encryption algorithms from the <a href="https://www.w3.org/TR/WebCryptoAPI/#subtlecrypto-interface">SubtleCrypto interface</a></p>

<table>
<thead>
<tr>
<th>Algorithm</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td><a href="https://tools.ietf.org/html/rfc3602">AES-128-CBC</a></td>
<td>For symmetric encryption</td>
</tr>

<tr>
<td><a href="https://tools.ietf.org/html/rfc2437#section-7.1">RSAES-OAEP</a></td>
<td>For asymmetric encryption (2048 bit key)</td>
</tr>

<tr>
<td><a href="https://tools.ietf.org/html/rfc3447#section-8.1">RSASSA-PSS (PS256)</a></td>
<td>For signing (2048 bit key)</td>
</tr>
</tbody>
</table>

<h2 id="data-storage-and-transmission">Data storage and transmission</h2>

<p>All messages transmitted between Service, Operator and App is sent in the form of JWT and signed with the sender party&rsquo;s own signing key. All Egendata messaging schemas(JWT) contains the property &ldquo;type&rdquo; to make it easier for the recipient to easily identify the purpose of the incoming message.</p>

<p>The Egendata solution uses the <a href="https://github.com/panva/jose">Panva</a> implementation of <a href="JOSE">JavaScript Object Signing and Encryption</a> as the serialization format for storage and transmission of signed/encrypted data.</p>

<p>The JOSE framework is based upon the following RFCs:</p>

<table>
<thead>
<tr>
<th>RFC</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td><a href="https://tools.ietf.org/html/rfc7517">JWK</a></td>
<td>JSON Web Key RFC7517, format for encryption keys.</td>
</tr>

<tr>
<td><a href="https://tools.ietf.org/html/rfc7516">JWE</a></td>
<td>JSON Web Encryption RFC7516, format för encrypted data. In Egendata solution only the &ldquo;General JWE JSON Serialization Syntax&rdquo; is used due to that being the only one supporting multiple recipients. The content is encrypted with &ldquo;A128CBC-HS256&rdquo;(link?) and the recipient keys with &ldquo;RSA-OAP&rdquo;.</td>
</tr>

<tr>
<td><a href="https://tools.ietf.org/html/rfc7515">JWS</a></td>
<td>JSON Web Signature RFC7515, format for signed data. All data is signed before being encrypted. This allows the validation of the data source.</td>
</tr>

<tr>
<td><a href="https://tools.ietf.org/html/rfc7519">JWT</a></td>
<td>JSON Web Token RFC7519, format for transmission of claims between all parts of the Egendata solution.</td>
</tr>
</tbody>
</table>

<p>Data saved in a user&rsquo;s PDS is always represented as JWE.</p>

<h2 id="trust-establishment">Trust establishment</h2>

<p>All communication with the Operator is established via TLS (although not enforced).</p>

<p>The Egendata signature validation is grounded in the fact that the signee service has a valid certificate issued from a trusted CA. The recipient of an incoming message, queries the supposed signee service(sub) to obtain the signee’s public key. Through secure TLS connection it trusts that it&rsquo;s in contact with the correct signee service and therefore also trusts the received public key. The signee&rsquo;s public key is then used for validation of the signature to ensure that said proposed service is the issuer and signee the received data.</p>

<p>This kind of signature verification also occurs when services consume data produced by other services.</p>

<h2 id="egendata-messages-properties-and-purposes">Egendata messages properties and purposes</h2>

<h3 id="service-registration">SERVICE_REGISTRATION</h3>

<p><em>This is the message sent to the operator by a service, when the later registers itself.</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td>_PURPOSE_GOES<em>HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>displayName</code></td>
<td><em>The name the service wants to display to users.</em></td>
</tr>

<tr>
<td><code>description</code></td>
<td><em>The description the service wants to display to the users.</em></td>
</tr>

<tr>
<td><code>iconURI</code></td>
<td><em>Relative or actual URI of the icon the service wants to display to the users.</em></td>
</tr>

<tr>
<td><code>jwksURI</code></td>
<td><em>The main URI linked to the service. It will also be used as the service’s id in the database.</em></td>
</tr>

<tr>
<td><code>eventsURI</code></td>
<td><em>The URI the service will be receiving event responses.</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="account-registration">ACCOUNT_REGISTRATION</h3>

<p>__</p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>pds</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- pds.provider</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- access_token</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="authentication-request">AUTHENTICATION_REQUEST</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>sid</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>eventsURI</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="connection-init">CONNECTION_INIT</h3>

<p><em>Initiates a connection between the user and the service. Is triggered when there is no pre-existing connection between these two parties.</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>sid</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="lawful-basis">LAWFUL_BASIS</h3>

<p><em>Defines the reasons the service needs to request each piece of data from the user. Is defined when the service is registered. Unless specified otherwise this is allows consent to the areas.</em></p>

<hr />

<h3 id="content-path">CONTENT_PATH</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>domain</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>area</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="permission-base">PERMISSION_BASE</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...CONTENT_PATH</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>id</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>lawfulBasis</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="read-permission-request">READ_PERMISSION_REQUEST</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...PERMISSION_BASE</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>purpose</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>jwk</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="write-permission-request">WRITE_PERMISSION_REQUEST</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...PERMISSION_BASE</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>description</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="permission-request-array">PERMISSION_REQUEST_ARRAY</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>READ_PERMISSION_REQUEST</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>WRITE_PERMISSION_REQUEST</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="read-permission">READ_PERMISSION</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...PERMISSION_BASE</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>purpose</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>kid</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="write-permission">WRITE_PERMISSION</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...PERMISSION_BASE</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>description</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>jwks</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="permission-array">PERMISSION_ARRAY</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>READ_PERMISSION</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>WRITE_PERMISSION</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="permission-denied">PERMISSION_DENIED</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...PERMISSION_BASE</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="permission-request">PERMISSION_REQUEST</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>permissions</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>sub</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>sid</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="connection-request">CONNECTION_REQUEST</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>permissions</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>sid</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>displayName</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>description</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>iconURI</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="connection">CONNECTION</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>sid</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>sub</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>permissions</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- approved</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- denied</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="connection-response">CONNECTION_RESPONSE</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>payload</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="connection-event">CONNECTION_EVENT</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>payload</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="login">LOGIN</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>sid</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>sub</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="login-response">LOGIN_RESPONSE</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>payload</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="login-event">LOGIN_EVENT</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>payload</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="access-token">ACCESS_TOKEN</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>sub</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="data-read-request">DATA_READ_REQUEST</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>sub</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>paths</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- domain</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- area</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="data-read-response">DATA_READ_RESPONSE</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>sub</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>paths</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- ...CONTENT_PATH</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- data</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- error</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- - message</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- - status</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- - code</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- - stack</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<hr />

<h3 id="data-write">DATA_WRITE</h3>

<p><em>PURPOSE-GOES-HERE</em></p>

<table>
<thead>
<tr>
<th>Property</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>...JWT_DEFAULTS</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>type</code></td>
<td><em>Defines the type of the message sent.</em></td>
</tr>

<tr>
<td><code>sub</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>paths</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- ...CONTENT_PATH</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>

<tr>
<td><code>- data</code></td>
<td><em>PURPOSE-GOES-HERE</em></td>
</tr>
</tbody>
</table>

<h2 id="steps-performed-upon-writing-to-pds">Steps performed upon writing to PDS.</h2>

<h3 id="at-the-service">At the service</h3>

<ol>
<li>When a service wants to write to a user’s PDS, a JWT message of type &ldquo;DATA_WRITE&rdquo; is constructed with the following inputs are required: &ldquo;domain&rdquo;, &ldquo;area&rdquo; and optionally &ldquo;data&rdquo;(JWE). A &ldquo;DATA_WRITE&rdquo; without any data is essentially the same as clearing the data located at the “content path” of the user’s PDS.</li>
<li>First a signing key(JWK) is constructed based upon the &ldquo;domain&rdquo; and &ldquo;area&rdquo; (This is not fully implemented and instead the service&rsquo;s own private key(from the client configuration) is used).</li>
<li>The &ldquo;data&rdquo; is signed with the service&rsquo;s private key and represented as an JWS object.</li>
<li>A JWE is then constructed based upon the JWS and each read permissioned recipient.</li>
<li>Finally the JWE is packed into a JWT and transmitted over to the Operator.</li>
</ol>

<h3 id="at-the-operator">At the operator</h3>

<ol>
<li>The Operator receives the incoming message(JWT) and validates the integrity of the message(JWT signature verification).</li>
<li>After that, the Operator performs queries to its own database based upon the JWT properties &ldquo;sub&rdquo;, &ldquo;iss&rdquo;, &ldquo;domain&rdquo; and &ldquo;area&rdquo; of each &ldquo;content path&rdquo; entry. (See the Egendata messaging schemas&hellip;)</li>
<li>If valid write permissions are found by the queries, the query result contains details about the &ldquo;pdsProvider&rdquo; and &ldquo;pdsCredentials&rdquo;.</li>
<li>The destination PDS directory path is defined based upon &ldquo;connectionId&rdquo;, &ldquo;domain&rdquo; and &ldquo;area&rdquo;.
<code>/data/${encodeURIComponent(connectionId)}/${encodeURIComponent(domain)}/${encodeURIComponent(area)}/data.json</code></li>
<li>The JWE(encrypted at the service) of the received JWT, is extracted and written to the users PDS and a successful status code 201 is returned to the service, alternatively 403 upon error.</li>
</ol>

<h2 id="steps-performed-upon-reading-from-pds">Steps performed upon reading from PDS</h2>

<h3 id="at-the-service-1">At the service</h3>

<ol>
<li>The Service constructs a JWT message (&ldquo;DATA_READ_REQUEST&rdquo;) with desired &ldquo;content paths&rdquo; and a connectionId(sub).</li>
<li>The message(JWT) is transmitted to the Operator.</li>
</ol>

<h3 id="at-the-operator-1">At the operator</h3>

<ol>
<li>The Operator receives the incoming message(JWT) and performs a lookup in its database to verify that the requesting Service has sufficient read permissions for a user’s PDS.</li>
<li>If valid sufficient read permissions are found, the database query result contains details about the &ldquo;pdsProvider&rdquo; and &ldquo;pdsCredentials&rdquo;.</li>
<li>The Operator constructs the &ldquo;content path&rdquo; strings that locate the data within the user&rsquo;s PDS. <code>/data/${encodeURIComponent(connectionId)}/${encodeURIComponent(domain)}/${encodeURIComponent(area)}/data.json</code></li>
<li>The data(JWE) is read from the user&rsquo;s PDS, packed into a new JWT message of type &ldquo;DATA_READ_RESPONSE&rdquo; and finally transmitted back to the requesting Service.</li>
</ol>

<h3 id="at-the-service-2">At the service</h3>

<ol>
<li>The service receives the incoming message(JWT) and iterates through all listed &ldquo;content paths&rdquo;

<ol>
<li>The Service inspects the JWE and locates its own &ldquo;Recipient&rdquo; key.</li>
<li>The Service obtains the required decryption key for the encrypted data, through decrypting its own &ldquo;Recipient&rdquo; entry with it&rsquo;s own private key.</li>
<li>The JWE is then decrypted with the decryption key.</li>
</ol></li>
<li>All &ldquo;content paths&rdquo; are returned with decrypted data, alternatively error if something went wrong in the previous step.</li>
</ol>

<p>:warning: Ask/Check if the Service&rsquo;s received message contains all intended Recipients or just a single one.</p>

<h2 id="future-plans-suggestions">Future plans / Suggestions</h2>

<p>We see possibilities to use the ASE-256-CBC for symmetric encryption.
There are no current plans to migrate to ECDSA for signing.</p>

<p>Eventually signing key rotation is expected to be implemented, so that each message can be validated against the public key announced by sending party. The exception is the App, which is not acting as a Webserver, and therefore can&rsquo;t publically announce its own public key, instead the public key is included in the message.</p>

<p>!!! Is there ANY cases where the App initiates a message directly to the Service? That message could potentially be tampered with. Yes, as far as we identified we can see that the CONNECTION_INIT message is transmitted directly to the Service if the App(device) doesn’t have an (cached) existing record of connection with the Service.</p>

<p>!!! Currently TLS is not enforced by the Egendata solution but it should probably be.</p>

<p>!!! The data producer signature verification is intended to be implemented in the Client library, however it&rsquo;s not yet implemented, see: <a href="https://github.com/egendata/client/blob/master/lib/data.js#L74">GitHub Client</a>.</p>

<p>There are potential optimizations to be done in the Panva JOSE library regarding the contruction and decryption the JWT&rsquo;s JWE content, e.g. the extraction of the correct key from the recipient list and to reuse of the same encryption key(but always with unique IV).</p>

<h2 id="other">Other</h2>

<p>! The Example project uses &ldquo;Client&rdquo; (and indirectly &ldquo;Messaging&rdquo;) library
! The Operator uses &ldquo;Messaging&rdquo; library
! The App uses &ldquo;Messaging&rdquo; library
! Describe the purpose of the &ldquo;Messaging&rdquo; library.
! Describe the purpose of the &ldquo;Client&rdquo; library, and update the current Readme.</p>

<hr />

<h1 id="data">Data</h1>

<h2 id="data-structures-storage">Data structures &amp; storage</h2>

<ul>
<li><p>The user’s data is stored in a json “blob” format.</p></li>

<li><p>No data structure has been defined for the user’s data. It instead keeps the tags of the form it was generated in as the field names. This means that the service dictates the structure of the data that is generated and consumed by it, as well as stored in the PDS.</p></li>

<li><p>The only data stored in the operator is the database records of (registered) users, services, their connections and consents given. This database schema is set up by the scripts in the “migrations” folder of the operator. One of those scripts generates a table called “pgmigrations” that holds the information about when and how (successfully or not) the other tables were generated.</p></li>

<li><p>The account data is stored in the operator in a postgres database.</p></li>

<li><p>Information stored (keys and cached permissions) on the user’s phone is stored in the sync local storage of the device.</p></li>

<li><p>In the current implementation of Egendata, when the user selects to store their data in memory, the data is stored in the internal memory of the operator. This includes and is limited to the data generated by the user in the different services.</p></li>
</ul>

<h2 id="step-by-step-for-data-generation">Step-by-step for data generation</h2>

<h3 id="registering-of-a-service">Registering of a service</h3>

<p>The following messages are required to establish a service as registered:</p>

<ul>
<li><code>SERVICE_REGISTRATION</code> sends a message containing the information describing the service.</li>
<li><code>LAWFUL_BASIS</code> contains information about the reason the service requires to read the data from the user.</li>
<li><code>PERMISSION_BASE</code> contains information about the reason the service will request permission to the different areas of the user’s profile.</li>
</ul>

<h3 id="registering-a-user">Registering a user</h3>

<p>When a user is registering the following information is being generated and sent to the operator:</p>

<ul>
<li><code>ACCOUNT_REGISTRATION</code> the user’s device generates a unique id and sends it, as part of the message, to the operator, who prefixes it to the account.</li>
</ul>

<h3 id="logging-in-to-a-service-with-egendata">Logging in to a service with Egendata</h3>

<p>In this step we need to consider if the user has an already established connection or not with the service they are trying to log in to. In both cases the process starts by scanning the QR  code of the service with the user’s device. After the QR code is scanned and until the following steps are completed the browser that housed the QR code starts polling the Operator for an ACCESS_TOKEN.</p>

<h4 id="with-an-established-connection">With an established connection</h4>

<p>In this case, the user’s device recognises that there is an existing connection with this service stored in the App’s internal cache and the following messages are triggered:</p>

<ol>
<li>A <code>LOGIN_RESPONSE</code> containing a serialized JWS <code>LOGIN</code> as payload is sent to the operator. This <code>LOGIN_RESPONSE</code> contains the user’s ID as the subject(iss?), and the service as a string in the body(within the <code>LOGIN</code>).</li>
<li>The operator extracts the <code>LOGIN</code> from the <code>LOGIN_RESPONSE</code> a wraps it in a new  <code>LOGIN_EVENT</code> message and forwards the message to the service. This happens so the service doesn’t get access to the user’s ID.</li>
</ol>

<h4 id="without-an-established-connection">Without an established connection</h4>

<p>If this user’s device does not recognise the service then the following messages are triggered:</p>

<ol>
<li>A <code>CONNECTION_INIT</code> is sent from the user’s device directly to the service’s <code>/events</code> endpoint.</li>
<li>The service responds with a <code>CONNECTION_REQUEST</code> to the user’s device.</li>
<li>The <code>CONNECTION_REQUEST</code> might optionally contain a <code>PERMISSION_REQUEST_ARRAY</code> detailing all the areas it is requesting access from the user’s profile.</li>
<li>If the <code>PERMISSION_REQUEST_ARRAY</code> is missing, at the moment, there is no way to send this in a later stage in the communication. There is no error handling for this eventuality and it will result in the system not working, because it will find a null string where it is expecting a not null string.</li>
<li>Each <code>PERMISSION_REQUEST</code> in the <code>PERMISSION_REQUEST_ARRAY</code> contains a <code>LAWFUL_BASIS</code>. In the current implementation this is defaulted to consent unless specified otherwise.</li>
<li>For read permissions the read key is sent alongside the permission, in the form of a kid.</li>
<li>The description of a write permission could be the schema that needs to be followed. Although, this is not implemented.</li>
<li>The key used in the write permissions is the public key derived by the private key sent through a read permission. Instead the path to the jwks is attached. The jwks contains the public keys of the user and the service, that are needed to read and write stuff.</li>
<li>After receiving the <code>CONNECTION_REQUEST</code> the device generates a <code>CONNECTION</code> wrapped in a <code>CONNECTION_RESPONSE</code> that is sent to the operator.</li>
<li>The operator upon receiving the CONNECTION_RESPONSE extracts from it the <code>CONNECTION</code> and rewrapes it in a <code>CONNECTION_EVENT</code> that is sent to the service.</li>
</ol>

<h2 id="reading-data-from-pds">Reading data from PDS</h2>

<p>For this process the operator accesses the user’s pds and reads the data requested by the service, as defined by the domain and area sent in though a <code>DATA_READ_REQUEST</code>. This means that a service could request data from other services by including another service’s domain in the <code>DATA_READ_REQUEST</code> message.
The requested data is sent to the service by the operator with a <code>DATA_READ_RESPONSE</code>.</p>

<ul>
<li>The domain defined in the request in the services ID, which is the URI of the service.</li>
<li>The areas that are defined in the request are the different areas of the CV.</li>
<li>The response to the request is sent with a &lt;&gt; message for each path requested. This means that for each domain and area path that has been requested the data stored in that folder is sent to the service separately.</li>
<li>These responses are sent encrypted and then decrypted by the client library.</li>
</ul>

<h2 id="writing-data-to-a-pds">Writing data to a PDS</h2>

<p>For this process the domain, area and data that needs to be written are sent with a <code>DATA_WRITE</code> message, from the service to the operator.
The data are encrypted before being sent to the operator, and then written to the PDS.
If there is a permission for writing to the user’s PDS the operator writes the data to the PDS. If there is no such permission.
Since all of the data are handled with one message, if even one of the areas is missing a write permission, the operation fails and the data is discarded.</p>

<hr />

<h2 id="configuration-properties-for-client-library">Configuration properties for Client library</h2>

<p>This section describes each configuration property of the Client library.</p>

<table>
<thead>
<tr>
<th>Configuration property</th>
<th>Data type</th>
<th>Purpose</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>displayName</code></td>
<td><code>string</code></td>
<td><em>Name of this service/application</em></td>
</tr>

<tr>
<td><code>description</code></td>
<td><code>string</code></td>
<td><em>A short description of this Service</em></td>
</tr>

<tr>
<td><code>iconURI</code></td>
<td><code>string</code></td>
<td><em>A URI to this service&rsquo;s logotype/icon</em></td>
</tr>

<tr>
<td><code>clientId</code></td>
<td><code>string</code></td>
<td><em>This is the identifier which this service will use to identify/register itself to the Operator with. Typically this will be the public <code>https://domain:port</code> this service is hosted on</em></td>
</tr>

<tr>
<td><code>operator</code></td>
<td><code>string</code></td>
<td><em>This is field specifies the <code>https://domain:port</code> to the central Operator service.</em></td>
</tr>

<tr>
<td><code>jwksPath</code></td>
<td><code>string</code></td>
<td><em>This field specifies where this service&rsquo;s JWKS is exposed/found, e.g. <code>/jwks</code></em></td>
</tr>

<tr>
<td><code>clientKey</code></td>
<td><code>string</code></td>
<td><em>This field specifies the private key(<code>PEM</code>/<code>JWK</code>) this service will use for encrypting- and signing of data.</em></td>
</tr>

<tr>
<td><code>keyValueStore</code></td>
<td><code>object</code></td>
<td><em>A reference to an object/adapter which can read, write and remove data to/from a storage. The keyValueStore must implement the following interface: <code>keyValueStore.save(key, value, ttl)</code>, <code>keyValueStore.load(key)</code> and <code>keyValueStore.remove(key)</code>.</em></td>
</tr>

<tr>
<td><code>defaultPermissions</code></td>
<td><code>array</code></td>
<td><em>An array of desired read/write permissions</em></td>
</tr>

<tr>
<td><code>defaultPermissions.#.area</code></td>
<td><code>string</code></td>
<td><em>An area describes where in the user&rsquo;s PDS to store/read data from, e.g. <code>baseData</code> or <code>experiences</code></em></td>
</tr>

<tr>
<td><code>defaultPermissions.#.types</code></td>
<td><code>array</code></td>
<td><em>An array that denotes which types of permissions are desired for this specific area. e.g. <code>['READ']</code>, <code>['WRITE']</code> or both <code>['READ', 'WRITE']</code></em></td>
</tr>

<tr>
<td><code>defaultPermissions.#.purpose</code></td>
<td><code>string</code></td>
<td><em>A short purpose description of why this service requests this specific read/write permission, e.g. <code>'In order to create a CV using our website.'</code></em></td>
</tr>

<tr>
<td><code>defaultPermissions.#.description</code></td>
<td><code>string</code></td>
<td>_A short description of the area this permission request relates to, e.g. <code>'Personal information.'</code></td>
</tr>
</tbody>
</table>

<h1 id="keyprovider-client">KeyProvider (Client)</h1>

<p>The KeyProvider class is responsible for keeping track of known keys and tokens.</p>

<p>A configuration object must be passed into the KeyProvider constructor upon initialization.
There are 5 configuration properties that affect the construction of the KeyProvider object.</p>

<ul>
<li><code>config.clientKey</code></li>
<li><code>config.keyValueStore</code></li>
<li><code>config.keyOptions</code></li>
<li><code>config.jwksURI</code></li>
<li><code>config.alg</code></li>
</ul>

<p>The <code>KeyProvider</code> will utilize the <code>keyValueStorage</code> property to read and write from/to an external storage. E.g. The Egendata Example-CV service provides an adapter for a locally hosted the redis database. The <code>KeyProvider</code> will utilize and assume that three functions are defined in the referenced <code>KeyValueStore</code> object: <code>save(key, value, ttl)</code>, <code>load(key)</code> and <code>remove(key)</code>.</p>

<p>Values written by the Client to the external/referenced <code>KeyValueStore</code> are base64 encoded.</p>

<p>The Client signing key(aka. <code>clientKey</code>) is provided through the configuration parameter upon initialization of the <code>Client</code>. This client key is used for all signing done by this Client, however there are ideas to implement different signing keys for different domains/areas and/or key rotation.</p>

<h2 id="prefixes-defined-in-client-library">Prefixes defined in Client library</h2>

<pre><code>const KEY_PREFIX = 'key|&gt;'
const WRITE_KEYS_PREFIX = 'permissionId|&gt;'
const AUTHENTICATION_ID_PREFIX = 'authentication|&gt;'
</code></pre>

<h2 id="saving-key-to-keyvaluestore">Saving key to keyValueStore</h2>

<p><code>${KEY_PREFIX}${key.kid}</code>: key</p>

<h2 id="saving-write-keys-to-keyvaluestore">Saving write keys to keyValueStore:</h2>

<p><code>${WRITE_KEYS_PREFIX}${domain}|${area}</code>: jwks</p>

<h2 id="saving-authentication-token-to-keyvaluestore">Saving authentication token to keyValueStore</h2>

<p><code>${AUTHENTICATION_ID_PREFIX}${sid}</code>: accessToken</p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/docs/operator/" title="Operator"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/docs/services/" title="Services" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/docs/js/clipboard.min.js?1571220765"></script>
    <script src="/docs/js/perfect-scrollbar.min.js?1571220765"></script>
    <script src="/docs/js/perfect-scrollbar.jquery.min.js?1571220765"></script>
    <script src="/docs/js/jquery.sticky.js?1571220765"></script>
    <script src="/docs/js/featherlight.min.js?1571220765"></script>
    <script src="/docs/js/highlight.pack.js?1571220765"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/docs/js/modernizr.custom-3.6.0.js?1571220765"></script>
    <script src="/docs/js/learn.js?1571220765"></script>
    <script src="/docs/js/hugo-learn.js?1571220765"></script>

    <link href="/docs/mermaid/mermaid.css?1571220765" rel="stylesheet" />
    <script src="/docs/mermaid/mermaid.js?1571220765"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>
