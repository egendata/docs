---
title: Data
---

Placeholder

## Data structures & storage

- The user’s data is stored in json format.
- No data structure has been defined for the user’s data. It instead keeps the tags of the form it was generated in as the field names. This means that the service dictates the structure of the data that is generated and consumed by it, as well as stored in the PDS.
- The only data stored in the operator is the database records of (registered) users, services, their connections and consents given. This database schema is set up by the scripts in the “migrations” folder of the operator. One of those scripts generates a table called “pgmigrations” that holds the information about when and how (successfully or not) the other tables were generated.
- The account data is stored in the operator in a postgres database.
- Information stored (keys and cached permissions) on the user’s phone is stored in the sync local storage of the device.
- In the current implementation of Egendata, when the user selects to store their data in memory, the data is stored in the internal memory of the operator. This includes and is limited to the data generated by the user in the different services.

## Step-by-step for data generation

### Registering of a service

The following messages are required to establish a service as registered:

- `SERVICE_REGISTRATION` sends a message containing the information describing the service.
- `LAWFUL_BASIS` contains information about the reason the service requires to read the data from the user.
- `PERMISSION_BASE` contains information about the reason the service will request permission to the different areas of the user’s profile.

### Registering a user

When a user is registering the following information is being generated and sent to the operator:

- `ACCOUNT_REGISTRATION` the user’s device generates a unique id and sends it, as part of the message, to the operator, who prefixes it to the account.

### Logging in to a service with Egendata

In this step we need to consider if the user has an already established connection or not with the service they are trying to log in to. In both cases the process starts by scanning the QR  code of the service with the user’s device. After the QR code is scanned and until the following steps are completed the browser that housed the QR code starts polling the Operator for an `ACCESS_TOKEN`.

#### With an established connection

In this case, the user’s device recognises that there is an existing connection with this service stored in the App’s internal cache and the following messages are triggered:

1. A `LOGIN_RESPONSE` containing a serialized JWS `LOGIN` as payload is sent to the operator. This `LOGIN_RESPONSE` contains the user’s ID as the subject(iss?), and the service as a string in the body(within the `LOGIN`).
1. The operator extracts the `LOGIN` from the `LOGIN_RESPONSE` a wraps it in a new  `LOGIN_EVENT` message and forwards the message to the service. This happens so the service doesn’t get access to the user’s ID.

#### Without an established connection
If this user’s device does not recognise the service then the following messages are triggered:

1. A `CONNECTION_INIT` is sent from the user’s device directly to the service’s `/events` endpoint.
1. The service responds with a `CONNECTION_REQUEST` to the user’s device.
1. The `CONNECTION_REQUEST` might optionally contain a `PERMISSION_REQUEST_ARRAY` detailing all the areas it is requesting access from the user’s profile. 
1. If the `PERMISSION_REQUEST_ARRAY` is missing, at the moment, there is no way to send this in a later stage in the communication. There is no error handling for this eventuality and it will result in the system not working, because it will find a null string where it is expecting a not null string.
1. Each `PERMISSION_REQUEST` in the `PERMISSION_REQUEST_ARRAY` contains a `LAWFUL_BASIS`. In the current implementation this is defaulted to consent unless specified otherwise.
1. For read permissions the read key is sent alongside the permission, in the form of a kid. 
1. The description of a write permission could be the schema that needs to be followed. Although, this is not implemented.
1. The key used in the write permissions is the public key derived by the private key sent through a read permission. Instead the path to the jwks is attached. The jwks contains the public keys of the user and the service, that are needed to read and write stuff.
1. After receiving the `CONNECTION_REQUEST` the device generates a `CONNECTION` wrapped in a `CONNECTION_RESPONSE` that is sent to the operator.
1. The operator upon receiving the CONNECTION_RESPONSE extracts from it the `CONNECTION` and rewrapes it in a `CONNECTION_EVENT` that is sent to the service. 

## Reading data from PDS

For this process the operator accesses the user’s pds and reads the data requested by the service, as defined by the domain and area sent in though a `DATA_READ_REQUEST`. This means that a service could request data from other services by including another service’s domain in the `DATA_READ_REQUEST` message. 
The requested data is sent to the service by the operator with a `DATA_READ_RESPONSE`.

- The domain defined in the request in the services ID, which is the URI of the service.
- The areas that are defined in the request are the different areas of the CV.
- The response to the request is sent with a <> message for each path requested. This means that for each domain and area path that has been requested the data stored in that folder is sent to the service separately.
- These responses are sent encrypted and then decrypted by the client library.

## Writing data to a PDS

For this process the domain, area and data that needs to be written are sent with a `DATA_WRITE` message, from the service to the operator. 
The data are encrypted before being sent to the operator, and then written to the PDS. 
If there is a permission for writing to the user’s PDS the operator writes the data to the PDS. If there is no such permission.
Since all of the data are handled with one message, if even one of the areas is missing a write permission, the operation fails and the data is discarded.

## Egendata message/schema definitions

### Common

_Some values are present in all messages. These are reused as `JWT_DEFAULTS`:

Property | Purpose
--- | ---

### SERVICE_REGISTRATION

_This is the message sent to the operator by a service, when the later registers itself._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE_GOES_HERE_
`type` | _Defines the type of the message sent._
`displayName` | _The name the service wants to display to users._
`description` | _The description the service wants to display to the users._
`iconURI` | _Relative or actual URI of the icon the service wants to display to the users._
`jwksURI` | _The main URI linked to the service. It will also be used as the service’s id in the database._
`eventsURI` | _The URI the service will be receiving event responses._

---

### ACCOUNT_REGISTRATION

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`pds` | _PURPOSE-GOES-HERE_
`- pds.provider` | _PURPOSE-GOES-HERE_
`- access_token` | _PURPOSE-GOES-HERE_

---

### AUTHENTICATION_REQUEST

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`sid` | _PURPOSE-GOES-HERE_
`eventsURI` | _PURPOSE-GOES-HERE_

---

### CONNECTION_INIT

_Initiates a connection between the user and the service. Is triggered when there is no pre-existing connection between these two parties._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`sid` | _PURPOSE-GOES-HERE_

---

### LAWFUL_BASIS

_Defines the reasons the service needs to request each piece of data from the user. Is defined when the service is registered. Unless specified otherwise this is allows consent to the areas._

---

### CONTENT_PATH

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`domain` | _PURPOSE-GOES-HERE_
`area` | _PURPOSE-GOES-HERE_

---

### PERMISSION_BASE

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...CONTENT_PATH` | _PURPOSE-GOES-HERE_
`id` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._ 
`lawfulBasis` | _PURPOSE-GOES-HERE_

---

### READ_PERMISSION_REQUEST

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...PERMISSION_BASE` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`purpose` | _PURPOSE-GOES-HERE_
`jwk` | _PURPOSE-GOES-HERE_

---

### WRITE_PERMISSION_REQUEST

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...PERMISSION_BASE` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`description` | _PURPOSE-GOES-HERE_

---

### PERMISSION_REQUEST_ARRAY

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`READ_PERMISSION_REQUEST` | _PURPOSE-GOES-HERE_
`WRITE_PERMISSION_REQUEST` | _PURPOSE-GOES-HERE_

---

### READ_PERMISSION

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...PERMISSION_BASE` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`purpose` | _PURPOSE-GOES-HERE_
`kid` | _PURPOSE-GOES-HERE_

---

### WRITE_PERMISSION

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...PERMISSION_BASE` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`description` | _PURPOSE-GOES-HERE_
`jwks` | _PURPOSE-GOES-HERE_

---

### PERMISSION_ARRAY

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`READ_PERMISSION` | _PURPOSE-GOES-HERE_
`WRITE_PERMISSION` | _PURPOSE-GOES-HERE_

---

### PERMISSION_DENIED

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...PERMISSION_BASE` | _PURPOSE-GOES-HERE_

---

### PERMISSION_REQUEST

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`permissions` | _PURPOSE-GOES-HERE_
`sub` | _PURPOSE-GOES-HERE_
`sid` | _PURPOSE-GOES-HERE_

---

### CONNECTION_REQUEST

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`permissions` | _PURPOSE-GOES-HERE_
`sid` | _PURPOSE-GOES-HERE_
`displayName` | _PURPOSE-GOES-HERE_
`description` | _PURPOSE-GOES-HERE_
`iconURI` | _PURPOSE-GOES-HERE_

---

### CONNECTION

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`sid` | _PURPOSE-GOES-HERE_
`sub` | _PURPOSE-GOES-HERE_
`permissions` | _PURPOSE-GOES-HERE_
`- approved` | _PURPOSE-GOES-HERE_
`- denied` | _PURPOSE-GOES-HERE_

---

### CONNECTION_RESPONSE

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`payload` | _PURPOSE-GOES-HERE_

---

### CONNECTION_EVENT

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`payload` | _PURPOSE-GOES-HERE_

---

### LOGIN

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`sid` | _PURPOSE-GOES-HERE_
`sub` | _PURPOSE-GOES-HERE_

---

### LOGIN_RESPONSE

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`payload` | _PURPOSE-GOES-HERE_

---

### LOGIN_EVENT

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`payload` | _PURPOSE-GOES-HERE_

---

### ACCESS_TOKEN

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`sub` | _PURPOSE-GOES-HERE_

---

### DATA_READ_REQUEST

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`sub` | _PURPOSE-GOES-HERE_
`paths` | _PURPOSE-GOES-HERE_
`- domain` | _PURPOSE-GOES-HERE_
`- area` | _PURPOSE-GOES-HERE_

---

### DATA_READ_RESPONSE

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`sub` | _PURPOSE-GOES-HERE_
`paths` | _PURPOSE-GOES-HERE_
`- ...CONTENT_PATH` | _PURPOSE-GOES-HERE_
`- data` | _PURPOSE-GOES-HERE_
`- error` | _PURPOSE-GOES-HERE_
`- - message` | _PURPOSE-GOES-HERE_
`- - status` | _PURPOSE-GOES-HERE_
`- - code` | _PURPOSE-GOES-HERE_
`- - stack` | _PURPOSE-GOES-HERE_

---

### DATA_WRITE

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _PURPOSE-GOES-HERE_
`type` | _Defines the type of the message sent._
`sub` | _PURPOSE-GOES-HERE_
`paths` | _PURPOSE-GOES-HERE_
`- ...CONTENT_PATH` | _PURPOSE-GOES-HERE_
`- data` | _PURPOSE-GOES-HERE_
