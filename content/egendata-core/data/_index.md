---
title: Data
---

Placeholder

## Data structures & storage

- The user’s data is stored in json format.
- No data structure has been defined for the user’s data. It instead keeps the tags of the form it was generated in as the field names. This means that the service dictates the structure of the data that is generated and consumed by it, as well as stored in the PDS.
- The only data stored in the operator is the database records of (registered) users, services, their connections and consents given. This database schema is set up by the scripts in the “migrations” folder of the operator. One of those scripts generates a table called “pgmigrations” that holds the information about when and how (successfully or not) the other tables were generated.
- The account data is stored in the operator in a postgres database.
- Information stored (keys and cached permissions) on the user’s phone is stored in the sync local storage of the device.
- In the current implementation of Egendata, when the user selects to store their data in memory, the data is stored in the internal memory of the operator. This includes and is limited to the data generated by the user in the different services.

## Step-by-step for data generation

### Registering of a service

The following messages are required to establish a service as registered:

- `SERVICE_REGISTRATION` sends a message containing the information describing the service.
- `LAWFUL_BASIS` contains information about the reason the service requires to read the data from the user.
- `PERMISSION_BASE` contains information about the reason the service will request permission to the different areas of the user’s profile.

### Registering a user

When a user is registering the following information is being generated and sent to the operator:

- `ACCOUNT_REGISTRATION` the user’s device generates a unique id and sends it, as part of the message, to the operator, who prefixes it to the account.

### Logging in to a service with Egendata

In this step we need to consider if the user has an already established connection or not with the service they are trying to log in to. In both cases the process starts by scanning the QR  code of the service with the user’s device. After the QR code is scanned and until the following steps are completed the browser that housed the QR code starts polling the Operator for an `ACCESS_TOKEN`.

#### With an established connection

In this case, the user’s device recognises that there is an existing connection with this service stored in the App’s internal cache and the following messages are triggered:

1. A `LOGIN_RESPONSE` containing a serialized JWS `LOGIN` as payload is sent to the operator. This `LOGIN_RESPONSE` contains the user’s ID as the subject(iss?), and the service as a string in the body(within the `LOGIN`).
1. The operator extracts the `LOGIN` from the `LOGIN_RESPONSE` a wraps it in a new  `LOGIN_EVENT` message and forwards the message to the service. This happens so the service doesn’t get access to the user’s ID.

#### Without an established connection

If this user’s device does not recognise the service then the following messages are triggered:

1. A `CONNECTION_INIT` is sent from the user’s device directly to the service’s `/events` endpoint.
1. The service responds with a `CONNECTION_REQUEST` to the user’s device.
1. The `CONNECTION_REQUEST` might optionally contain a `PERMISSION_REQUEST_ARRAY` detailing all the areas it is requesting access from the user’s profile.
1. If the `PERMISSION_REQUEST_ARRAY` is missing, at the moment, there is no way to send this in a later stage in the communication. There is no error handling for this eventuality and it will result in the system not working, because it will find a null string where it is expecting a not null string.
1. Each `PERMISSION_REQUEST` in the `PERMISSION_REQUEST_ARRAY` contains a `LAWFUL_BASIS`. In the current implementation this is defaulted to consent unless specified otherwise.
1. For read permissions the read key is sent alongside the permission, in the form of `kid` (key id).
1. The description of a write permission could be the schema that needs to be followed. Although, this is not implemented.
1. The key used in the write permissions is the public key derived by the private key sent through a read permission. Instead the path to the jwks is attached. The jwks contains the public keys of the user and the service, that are needed to read and write stuff.
1. After receiving the `CONNECTION_REQUEST` the device generates a `CONNECTION` wrapped in a `CONNECTION_RESPONSE` that is sent to the operator.
1. The operator upon receiving the `CONNECTION_RESPONSE` extracts from it the `CONNECTION` and rewrapes it in a `CONNECTION_EVENT` that is sent to the service.

## Reading data from PDS

For this process the operator accesses the user’s pds and reads the data requested by the service, as defined by the domain and area sent in though a `DATA_READ_REQUEST`. This means that a service could request data from other services by including another service’s domain in the `DATA_READ_REQUEST` message.
The requested data is sent to the service by the operator with a `DATA_READ_RESPONSE`.

{{% notice tip %}}
Currently only Dropbox is supported as a PDS. It is, however, called through an abstraction which treats it as `fs`. This means that as long as another PDS can be called through the same abstraction, it is simple to implement.
{{% /notice % }}

- The domain defined in the request in the services ID, which is the URI of the service.
- The areas that are defined in the request are the different areas of the CV.
- The response to the request is sent with a <> message for each path requested. This means that for each domain and area path that has been requested the data stored in that folder is sent to the service separately.
- These responses are sent encrypted and then decrypted by the client library.

## Writing data to a PDS

For this process the domain, area and data that needs to be written are sent with a `DATA_WRITE` message, from the service to the operator.
The data are encrypted before being sent to the operator, and then written to the PDS.
If there is a permission for writing to the user’s PDS the operator writes the data to the PDS. If there is no such permission.
Since all of the data are handled with one message, if even one of the areas is missing a write permission, the operation fails and the data is discarded.

## Egendata message/schema definitions

All message schemas are defined in and validated through [./lib/schemas.js](https://github.com/egendata/messaging/blob/master/lib/schemas.js) in the `@egendata/messaging` npm package.

### Common

_Some values are present in all messages. These are reused as `JWT_DEFAULTS`:

Property | Purpose
--- | ---
iss | The issuer of the message. Example: `https://myservice.org`
aud | The intended audience of the message. Example: `https://operator.egendata.se`
iat | Unix timestamp for when the message was created.
exp | Unix timestamp for when the message expires.

### SERVICE_REGISTRATION

_Message sent to the operator by a service, when it registers itself._

Property | Purpose
--- | ---
`type` | _SERVICE_REGISTRATION_
`iss` | _The service's host URL_
`aud` | _The URL of the Operator
`displayName` | _The name the service wants to display to users._
`description` | _The description the service wants to display to the users._
`iconURI` | _Relative or actual URI of the icon the service wants to display to the users._
`jwksURI` | _The main URI linked to the service. It will also be used as the service’s id in the database._
`eventsURI` | _The URI the service will be receiving event responses._

---

### ACCOUNT_REGISTRATION

_Message sent from the user's device to the operator when they are registering an account._

Property | Purpose
--- | ---
`type` | _ACCOUNT_REGISTRATION_
`iss` | _egendata://account/[account_id]_
`aud` | _The URL of the Operator_
`pds` | _Information about the PDS the user has selected for their account._
`- pds.provider` | _The type of PDS used. As of now the options are Dropbox and in memory. In memory means the operators internal memory._
`- access_token` | _In the case the PDS requires authentication, this is the token to be used for it. As of now this applies to the Dropbox option._

---

### AUTHENTICATION_REQUEST

_Message sent by the service to the user's device to authenticate them._

Property | Purpose
--- | ---
`type` | _AUTHENTICATION_REQUEST_
`iss` | _The service's host URL_
`aud` | _egendata://account_
`type` | _Defines the type of the message sent._
`sid` | _The (browser) session id that this message was sent during._
`eventsURI` | _The URI that the service expects the responses to the messages to be received._

---

### CONNECTION_INIT

_Initiates a connection between the user and the service. Is triggered when there is no pre-existing connection between these two parties._

Property | Purpose
--- | ---
`type` | _CONNECTION_INIT_
`iss` | _egendata://account_
`aud` | _The service's host URL_
`sid` | _The (browser) session id that this message was sent during._

---

### LAWFUL_BASIS

_Defines the lawful basis of the information permission request as defined in GDPR. Currently all requests default to `CONSENT` and no architectural consessions have been made to handle other cases. Therefore all other values are disallowed in validation._

---

### CONTENT_PATH

_Instead of obtaining permission to store all sorts of data about the user, Egendata requires explicit permission per information area. These permissions might eventually be obtained with different lawful bases. Examples are `base_info`, `education`, `work-experience` and so on. Technically these areas will translate into paths on the PDS._

Property | Purpose
--- | ---
`domain` | _The URL of the data generating service_
`area` | _The name of the information given by the issuing service_

---

### READ_PERMISSION_REQUEST

_Message sent to request a read permission._

Property | Purpose
--- | ---
`...PERMISSION_BASE` | _Adds basic information about the permission requested._
`type` | _Defines the type of permission that is requested as READ._ 
`purpose` | _The purpose of the permission being requested._
`jwk` | _The key of the service that will be used when they decrypt the data for read purposes._

---

### WRITE_PERMISSION_REQUEST

_Message sent to request a write permissions. This can contain more than one `WRITE_PERMISSION`._

Property | Purpose
--- | ---
`...PERMISSION_BASE` |  _Adds basic information about the permission requested._
`type` | _Defines the type of permission that is requested as WRITE._ 
`description` | _The description of the requested permission._ //How is this different from the purpose in the READ_PERMISSION_REQUEST???

---

### PERMISSION_REQUEST_ARRAY

_The list of permission requests sent to the user for approval._

Property | Purpose
--- | ---
`READ_PERMISSION_REQUEST` | _The read permissions requested._
`WRITE_PERMISSION_REQUEST` | _The write permissions requested._

---

### READ_PERMISSION

_The information for each individual read permission requested._

Property | Purpose
--- | ---
`...PERMISSION_BASE` |  _Adds basic information about the permission requested._
`type` | _Defines the type of permission that is requested as READ._ 
`purpose` | _The reason the permission is requested._ // Why is the purpose needed in the READ_PERMISSION_REQUEST if it is here???
`kid` | _PURPOSE-GOES-HERE_

---

### WRITE_PERMISSION

_The information for each individual write permission requested._

Property | Purpose
--- | ---
`...PERMISSION_BASE` |  _Adds basic information about the permission requested._
`type` | _Defines the type of permission that is requested as WRITE._ 
`description` | _PURPOSE-GOES-HERE_ // Why is the description needed in the WRITE_PERMISSION_REQUEST if it is here???
`jwks` | _Link to the key store where the keys required to encrypt the data is stored._

---

### PERMISSION_ARRAY

_List of the permissions accepted by the user for this service._ 

Property | Purpose
--- | ---
`READ_PERMISSION` | _The read permissions requested._
`WRITE_PERMISSION` | _The write permissions requested._

---

### PERMISSION_DENIED

_A permission that has been denied by the user for this service._ 

Property | Purpose
--- | ---
`...PERMISSION_BASE` | _Adds basic information about the permission requested._

---

### CONNECTION_REQUEST

_Response to a `CONNECTION_INIT` message. Sent to the user's device by the service._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _Adds the information needed about the source of the message._
`type` | _Defines the type of the message sent._
`permissions` | _A `PERMISSION_REQUEST_ARRAY` list of at least one with permissions for the user to accept or deny._
`sid` | _The (browser) session id that this message was sent during._
`displayName` | _The display name of the service._
`description` | _The description of the service._
`iconURI` | _The icon of the service._

---

### CONNECTION

_Message sent from the user's device the operator who then forwards it to the service, containing information about the connection between the two endpoints._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _Adds the information needed about the source of the message._
`type` | _Defines the type of the message sent._
`sid` | _The (browser) session id that this message was sent during._
`sub` | _PURPOSE-GOES-HERE_
`permissions` | _Information about the permissions the user has accepted and denied._
`- approved` | _The list of approved permissions._
`- denied` | _The list of denied permissions._

---

### CONNECTION_RESPONSE

_The message sent by the device to the operator containing the `CONNECTION` message._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _Adds the information needed about the source of the message._
`type` | _Defines the type of the message sent._
`payload` | _The `CONNECTION`message sent as a serialized JWS type._

---

### CONNECTION_EVENT

_The message sent by the operator to the service containing the `CONNECTION` message._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _Adds the information needed about the source of the message._
`type` | _Defines the type of the message sent._
`payload` | _The `CONNECTION`message sent as a serialized JWS type._

---

### LOGIN

_Message sent from the user's device the operator who then forwards it to the service, so the user can login to the service._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _Adds the information needed about the source of the message._
`type` | _Defines the type of the message sent._
`sid` | _The (browser) session id that this message was sent during._
`sub` | _PURPOSE-GOES-HERE_

---

### LOGIN_RESPONSE

_The message sent by the device to the operator containing the `LOGIN` message._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _Adds the information needed about the source of the message._
`type` | _Defines the type of the message sent._
`payload` | _The `LOGIN` message sent as a serialized JWS type._

---

### LOGIN_EVENT

_The message sent by the operator to the service containing the `LOGIN` message._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _Adds the information needed about the source of the message._
`type` | _Defines the type of the message sent._
`payload` | _The `LOGIN` message sent as a serialized JWS type._

---

### ACCESS_TOKEN

_PURPOSE-GOES-HERE_

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _Adds the information needed about the source of the message._
`type` | _Defines the type of the message sent._
`sub` | _PURPOSE-GOES-HERE_

---

### DATA_READ_REQUEST

_Message sent by the service to the operator to request data for read purposes. This can contain more than one requests._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _Adds the information needed about the source of the message._
`type` | _Defines the type of the message sent._
`sub` | _PURPOSE-GOES-HERE_
`paths` | _The paths to the data the service is requesting to read,_
`- domain` | _The domain of the data the service requests to read. By default it is its own domain, but could also be a different service's domain._
`- area` | _The section of data the service requests to read, for example education, languages so on._

---

### DATA_READ_RESPONSE

_Response to a `DATA_READ_REQUEST` sent to the service by the operator. Each read request is handled and responded to individually._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _Adds the information needed about the source of the message._
`type` | _Defines the type of the message sent._
`sub` | _PURPOSE-GOES-HERE_
`paths` | _The paths to the data the service is requesting to read,_
`- ...CONTENT_PATH` | _PURPOSE-GOES-HERE_
`- data` | _The data sent back to the service for this particular request._
`- error` | _Error messages that might occur, for example missing data or denied permissions._
`- - message` | _The message of the error message._
`- - status` | _The status of the error message._
`- - code` | _The code of the error message._
`- - stack` | _PURPOSE-GOES-HERE_

---

### DATA_WRITE

_Message sent containing encrypted data to be written to the users PDS. The message is sent by the service to the operator. All the different domain and area paths that will be written to are handled together by one message of this type._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _Adds the information needed about the source of the message._
`type` | _Defines the type of the message sent._
`sub` | _PURPOSE-GOES-HERE_
`paths` | _List of domain and area paths that the data will be written to._
`- ...CONTENT_PATH` | _PURPOSE-GOES-HERE_
`- data` | _The data to be written in this path._

## Not yet implemented

### PERMISSION_REQUEST

_Message sent by the service to the operator in order to request permissions._

Property | Purpose
--- | ---
`...JWT_DEFAULTS` | _Adds the information needed about the source of the message._
`type` | _Defines the type of the message sent._
`permissions` | _A `PERMISSION_ARRAY`containing at least one permission._
`sub` | _PURPOSE-GOES-HERE_
`sid` | _The (browser) session id that this message was sent during._
